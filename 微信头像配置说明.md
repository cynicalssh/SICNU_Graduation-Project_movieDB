# 微信头像配置说明

## 问题说明

如果点击头像后显示灰色默认头像，而不是微信头像，可能是因为：

1. **微信头像URL需要配置downloadFile域名白名单**
2. **临时文件路径过期**

## 解决方案

### 方案1：配置downloadFile域名（推荐）

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发** -> **开发管理** -> **开发设置**
3. 找到 **服务器域名** -> **downloadFile合法域名**
4. 添加以下域名：
   - `https://wx.qlogo.cn`
   - `https://thirdwx.qlogo.cn`

### 方案2：使用临时文件（已实现）

代码已经实现了自动下载微信头像到本地临时文件的逻辑：
- 获取到微信头像URL后，自动使用 `wx.downloadFile` 下载
- 下载成功后，使用临时文件路径显示头像
- 同时保存原始URL，以便临时文件过期后重新下载

## 调试方法

1. **查看控制台日志**：
   - 打开微信开发者工具的控制台
   - 点击头像后，查看以下日志：
     - `获取到的用户信息:` - 查看获取到的完整用户信息
     - `头像URL:` - 查看原始头像URL
     - `头像下载成功:` - 查看下载后的临时文件路径

2. **检查头像URL**：
   - 如果头像URL是 `https://wx.qlogo.cn` 或 `https://thirdwx.qlogo.cn` 开头，说明是微信头像
   - 需要配置downloadFile域名白名单

3. **检查临时文件**：
   - 如果头像URL是 `http://tmp/` 或 `wxfile://` 开头，说明是临时文件
   - 临时文件可能会过期，代码会自动重新下载

## 常见问题

### Q: 为什么点击头像后还是显示默认头像？

A: 可能的原因：
1. 用户取消了授权
2. downloadFile域名未配置，下载失败
3. 网络问题导致下载失败

**解决方法**：
- 检查控制台是否有错误日志
- 确认是否配置了downloadFile域名
- 检查网络连接

### Q: 头像显示正常，但关闭小程序后再打开又变成默认头像了？

A: 这是因为临时文件过期了。代码已经实现了自动重新下载的逻辑，但需要确保：
1. 缓存中保存了 `originalAvatarUrl`（原始头像URL）
2. downloadFile域名已配置

### Q: 如何测试头像功能？

A: 
1. 清除小程序缓存（开发者工具 -> 清除缓存）
2. 打开"我的"页面
3. 点击头像
4. 授权后查看头像是否更新
5. 关闭小程序，重新打开，检查头像是否仍然显示

## 技术说明

### 头像URL类型

1. **微信头像URL**（需要下载）：
   - `https://wx.qlogo.cn/...`
   - `https://thirdwx.qlogo.cn/...`

2. **临时文件路径**（已下载）：
   - `http://tmp/...`
   - `wxfile://...`

3. **本地资源路径**：
   - `/resource/logo.png`

### 代码逻辑

1. **获取用户信息**：
   - 使用 `wx.getUserProfile` 获取用户信息（包含头像URL）

2. **下载头像**：
   - 检测到微信头像URL时，使用 `wx.downloadFile` 下载
   - 下载成功后，使用临时文件路径显示
   - 同时保存原始URL到 `originalAvatarUrl`

3. **缓存管理**：
   - 保存完整的用户信息（包括原始URL和临时路径）
   - 下次打开时，检查临时文件是否过期
   - 如果过期，使用原始URL重新下载

4. **错误处理**：
   - 下载失败时，尝试直接使用原始URL
   - 如果原始URL也无法加载，使用默认头像

