# 高德地图API配置说明

## 问题说明

当前项目使用的地图API都遇到了问题：
- 百度地图API：被禁用（status: 201）
- 腾讯地图API：Key无效（status: 190）

**解决方案：使用高德地图API（免费，稳定）**

## 申请高德地图Key步骤

### 1. 注册/登录高德开放平台

访问：https://console.amap.com/

如果没有账号，先注册；如果有账号，直接登录。

### 2. 创建应用

1. 登录后，进入"控制台"
2. 点击"应用管理" → "我的应用"
3. 点击"创建新应用"
4. 填写应用名称（例如：微信小程序-电影推荐）
5. 点击"确定"

### 3. 添加Key

1. 在刚创建的应用下，点击"添加"
2. 填写Key名称（例如：小程序Key）
3. **服务平台**选择：**Web服务**（重要！）
4. **IP白名单设置**（重要！）：
   - 如果看到"IP白名单"选项，设置为：`0.0.0.0/0`（允许所有IP）
   - 或者留空（不设置白名单限制）
   - 这是解决 `USERKEY_PLAT_NOMATCH` 错误的关键步骤
5. 点击"提交"

### 4. 获取Key

创建成功后，会显示一个Key（类似：`a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`）

### 5. 配置到项目中

打开 `comm/script/config.js` 文件，找到：

```javascript
amapKey: '',  // 高德地图Key（免费申请：https://console.amap.com/dev/key/app）
```

将你的Key填入：

```javascript
amapKey: '你的高德地图Key',  // 高德地图Key
```

### 6. 配置小程序域名

在微信小程序后台或开发者工具中，需要将以下域名添加到合法域名：

**高德地图API域名：**
- `restapi.amap.com`

**配置步骤：**

**方法一：开发环境（推荐）**
- 在微信开发者工具中，打开"设置" → "项目设置"
- 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

**方法二：生产环境**
- 登录微信小程序后台
- 进入"开发" → "开发管理" → "开发设置"
- 在"服务器域名"中添加：
  - `restapi.amap.com`（request 合法域名）

## 免费配额说明

高德地图Web服务API提供：
- **个人开发者**：每天30万次免费调用
- **企业开发者**：每天100万次免费调用

对于小程序项目来说，完全够用。

## 测试

配置完成后，重新运行小程序，打开控制台，应该能看到：

```
调用高德地图API，参数: 105.23822,32.5841
高德地图API响应: {...}
成功获取城市（高德地图）: 广元
```

## 备用方案

如果高德地图API也失败，代码会自动尝试：
1. 高德地图（主要）
2. 腾讯地图（备用1）
3. 百度地图（备用2）

## 常见错误及解决方法

### 错误1：USERKEY_PLAT_NOMATCH (错误码: 10009)

**错误信息：** `USERKEY_PLAT_NOMATCH` 或 `Key与请求平台不匹配`

**解决方法：**
1. 确认Key的服务平台选择了"**Web服务**"（不是"微信小程序"）
2. 在Key设置中，配置**IP白名单**：
   - 登录高德开放平台控制台
   - 找到你的应用和Key
   - 点击"设置"或"编辑"
   - 在"IP白名单"中设置为：`0.0.0.0/0`（允许所有IP）
   - 或者留空（不限制IP）
3. 保存后等待几分钟让配置生效

### 错误2：INVALID_USER_KEY (错误码: 10001)

**错误信息：** `INVALID_USER_KEY` 或 `Key无效`

**解决方法：**
- 检查Key是否正确复制到 `config.js` 中
- 确认Key没有多余的空格或换行
- Key创建后可能需要几分钟才能生效

### 错误3：DAILY_QUERY_OVER_LIMIT (错误码: 10003)

**错误信息：** `DAILY_QUERY_OVER_LIMIT` 或 `配额已用完`

**解决方法：**
- 个人开发者每天30万次免费调用，企业开发者每天100万次
- 如果超出限制，需要等待第二天或升级套餐

## 注意事项

1. **服务平台必须选择"Web服务"**，不能选择"微信小程序"
2. **IP白名单必须配置**：设置为 `0.0.0.0/0` 或留空，否则会报 `USERKEY_PLAT_NOMATCH` 错误
3. Key创建后可能需要几分钟才能生效
4. 如果修改了Key设置，需要等待几分钟让配置生效

## 参考链接

- 高德开放平台：https://lbs.amap.com/
- 控制台：https://console.amap.com/
- API文档：https://lbs.amap.com/api/webservice/guide/api/georegeo



