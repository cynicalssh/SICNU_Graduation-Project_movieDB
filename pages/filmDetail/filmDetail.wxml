<wxs module="dateUtil" src="../../util/dateUtil.wxs"></wxs>
<view class="container">
    <block wx:if="{{showLoading}}">
        <view class="loading">ç©å‘½åŠ è½½ä¸­â€¦</view>
    </block>
    <block wx:elif="{{showContent}}">
    <!-- fd: film detail -->
        <view class="fd-hd">
            <view class="fd-hd-bg" style="background-image: url({{filmDetail.images.large}})"></view>
            <image src="{{filmDetail.images.large}}" class="fd-cover"></image>
            <scroll-view class="fd-intro" scroll-y="true" enable-back-to-top="true">
                <view class="fd-title">{{filmDetail.title}}</view>
                <view class="fd-intro-txt">å¯¼æ¼”ï¼š{{filmDetail.directors[0].name}}</view>
                <view class="fd-intro-txt">æ¼”å‘˜ï¼š
                    <block wx:for="{{filmDetail.casts}}" wx:for-item="filmDetailCastItem" wx:for-index="filmDetailCastIndex" wx:key="filmDetailCastItem">
                        {{filmDetailCastItem.name}}
                        <block wx:if="{{filmDetailCastIndex !== filmDetail.casts.length - 1}}">/</block>
                    </block>
                </view>
                <view class="fd-intro-txt">è±†ç“£è¯„åˆ†ï¼š
                    <block wx:if="{{filmDetail.rating.average == 0}}">
                        æš‚æ— è¯„åˆ†
                    </block>
                    <block wx:else>
                        {{filmDetail.rating.average}}åˆ†
                    </block>
                </view>
                <view class="fd-intro-txt">ä¸Šæ˜ å¹´ä»½ï¼š{{filmDetail.year}}å¹´</view>
            </scroll-view>
            <view class="fd-favorite {{isFilmFavorite ? 'fd-favorite-active' : ''}}" bindtap="favoriteFilm">æ”¶è—</view>
        </view>
        <view class="fd-data">
            <view class="fd-data-item">
                <view class="fd-data-num">{{filmDetail.collect_count}}</view>
                <view class="fd-data-title">çœ‹è¿‡</view>
            </view>
            <view class="fd-data-item">
                <view class="fd-data-num">{{filmDetail.wish_count}}</view>
                <view class="fd-data-title">æƒ³çœ‹</view>
            </view>
            <view class="fd-data-item">
                <view class="fd-data-num">{{filmDetail.ratings_count}}</view>
                <view class="fd-data-title">è¯„åˆ†äººæ•°</view>
            </view>
        </view>
        <view class="fd-bd">
            <view class="fd-bd-title">å‰§æƒ…ç®€ä»‹</view>
            <view class="fd-bd-intro">{{filmDetail.summary}}</view>
            <view class="fd-bd-title">å¯¼æ¼”/æ¼”å‘˜</view>
            <view class="fd-bd-person">
                <view class="fd-bd-person-item" data-id="{{filmDetail.directors[0].id}}" bindtap="viewPersonDetail">
                    <image class="fd-bd-person-avatar" src="{{filmDetail.directors[0].avatars.medium}}" mode="aspectFill"></image>
                    <view class="fd-bd-person-name">{{filmDetail.directors[0].name}}</view>
                    <view class="fd-bd-person-role">å¯¼æ¼”</view>
                </view>
                <block wx:for="{{filmDetail.casts}}" wx:for-item="filmDetailCastItem" wx:key="filmDetailCastItem">
                    <view class="fd-bd-person-item" data-id="{{filmDetailCastItem.id}}" bindtap="viewPersonDetail">
                        <image class="fd-bd-person-avatar" src="{{filmDetailCastItem.avatars.medium}}" mode="aspectFill"></image>
                        <view class="fd-bd-person-name">{{filmDetailCastItem.name}}</view>
                        <view class="fd-bd-person-role">æ¼”å‘˜</view>
                    </view>
                </block>
            </view>
            <view class="fd-bd-title">æ ‡ç­¾</view>
            <view class="fd-bd-tag">
                <block wx:for="{{filmDetail.genres}}" wx:for-item="filmDetailTagItem" wx:key="filmDetailTagItem">
                    <view class="fd-bd-tag-item" data-tag="{{filmDetailTagItem}}" catchtap="viewFilmByTag">{{filmDetailTagItem}}</view>
                </block>
            </view>
            
            <!-- è¯„è®ºåŒº -->
            <view class="fd-bd-title">è¯„è®ºåŒº</view>
            <view class="fd-reviews">
                <block wx:if="{{reviews.length > 0}}">
                    <block wx:for="{{reviews}}" wx:for-item="reviewItem" wx:key="reviewItem.id">
                        <view class="fd-review-item">
                            <view class="fd-review-header">
                                <image class="fd-review-avatar" src="{{reviewItem.avatar}}" mode="aspectFill" wx:if="{{reviewItem.avatar}}"></image>
                                <view class="fd-review-avatar fd-review-avatar-placeholder" wx:else>{{reviewItem.author.substring(0, 1)}}</view>
                                <view class="fd-review-info">
                                    <view class="fd-review-author">{{reviewItem.author}}</view>
                                    <view class="fd-review-date">{{dateUtil.formatReviewDate(reviewItem.created_at)}}</view>
                                </view>
                                <view class="fd-review-rating" wx:if="{{reviewItem.rating}}">
                                    <text class="fd-review-rating-text">{{reviewItem.rating}}</text>
                                    <text class="fd-review-rating-star">â­</text>
                                </view>
                            </view>
                            <view class="fd-review-content">{{reviewItem.content}}</view>
                        </view>
                    </block>
                    <view class="fd-review-load-more" wx:if="{{reviewsHasMore}}" bindtap="loadMoreReviews">
                        <text wx:if="{{reviewsLoading}}">åŠ è½½ä¸­...</text>
                        <text wx:else>åŠ è½½æ›´å¤šè¯„è®º</text>
                    </view>
                    <view class="fd-review-load-more" wx:else>
                        <text>æ²¡æœ‰æ›´å¤šè¯„è®ºäº†</text>
                    </view>
                </block>
                <block wx:else>
                    <view class="fd-review-empty">
                        <text>æš‚æ— è¯„è®º</text>
                    </view>
                </block>
            </view>
            
            <!-- è®¨è®ºåŒº -->
            <view class="fd-bd-title">è®¨è®ºåŒº</view>
            <view class="fd-discussions">
                <block wx:if="{{discussions.length > 0}}">
                    <block wx:for="{{discussions}}" wx:for-item="discussionItem" wx:key="discussionItem.id">
                        <view class="fd-discussion-item">
                            <view class="fd-discussion-header">
                                <view class="fd-discussion-title">{{discussionItem.name}}</view>
                                <view class="fd-discussion-meta">
                                    <text class="fd-discussion-author">{{discussionItem.author}}</text>
                                    <text class="fd-discussion-date">{{dateUtil.formatReviewDate(discussionItem.created_at)}}</text>
                                </view>
                            </view>
                            <view class="fd-discussion-content" wx:if="{{discussionItem.description}}">{{discussionItem.description}}</view>
                            <view class="fd-discussion-footer">
                                <text class="fd-discussion-replies {{discussionItem.showReplies ? 'active' : ''}}" bindtap="toggleReplies" data-index="{{index}}">ğŸ’¬ {{discussionItem.replies_count || discussionItem.comment_count || 0}} æ¡å›å¤</text>
                                <text class="fd-discussion-score" wx:if="{{discussionItem.score}}">ğŸ‘ {{discussionItem.score}}</text>
                            </view>
                            <!-- å›å¤åˆ—è¡¨ -->
                            <view class="fd-discussion-replies-list" wx:if="{{discussionItem.showReplies}}">
                                <view class="fd-reply-loading" wx:if="{{discussionItem.repliesLoading}}">
                                    <text>åŠ è½½å›å¤ä¸­...</text>
                                </view>
                                <block wx:else>
                                    <block wx:if="{{discussionItem.replies && discussionItem.replies.length > 0}}">
                                        <view class="fd-reply-item" wx:for="{{discussionItem.replies}}" wx:for-item="replyItem" wx:key="replyItem.id">
                                            <view class="fd-reply-header">
                                                <text class="fd-reply-author">{{replyItem.author}}</text>
                                                <text class="fd-reply-date">{{dateUtil.formatReviewDate(replyItem.created_at)}}</text>
                                            </view>
                                            <view class="fd-reply-content">{{replyItem.content}}</view>
                                            <view class="fd-reply-footer" wx:if="{{replyItem.score}}">
                                                <text class="fd-reply-score">ğŸ‘ {{replyItem.score}}</text>
                                            </view>
                                        </view>
                                    </block>
                                    <view class="fd-reply-empty" wx:else>
                                        <text>æš‚æ— å›å¤</text>
                                    </view>
                                </block>
                            </view>
                        </view>
                    </block>
                    <view class="fd-discussion-load-more" wx:if="{{discussionsHasMore}}" bindtap="loadMoreDiscussions">
                        <text wx:if="{{discussionsLoading}}">åŠ è½½ä¸­...</text>
                        <text wx:else>åŠ è½½æ›´å¤šè®¨è®º</text>
                    </view>
                    <view class="fd-discussion-load-more" wx:else>
                        <text>æ²¡æœ‰æ›´å¤šè®¨è®ºäº†</text>
                    </view>
                </block>
                <block wx:else>
                    <view class="fd-discussion-empty">
                        <text>æš‚æ— è®¨è®º</text>
                    </view>
                </block>
            </view>
        </view>
    </block> 
</view>
<import src="../../component/message/message.wxml"/>
<template is="message" data="{{message: message}}"/>