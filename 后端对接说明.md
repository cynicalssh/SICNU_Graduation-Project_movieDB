# 小程序后端对接说明

## 已实现功能

✅ 小程序启动时自动调用后端登录接口
✅ 自动保存token、userId、openId到本地存储
✅ 如果已有token，直接使用，不重复登录

## 配置说明

### 1. 后端服务地址

在 `comm/script/config.js` 中配置：

```javascript
// 开发环境（本地测试）
var backendApiUrl = 'http://localhost:8080/api'

// 真机测试（需要改为你的电脑IP）
var backendApiUrl = 'http://192.168.1.100:8080/api'  // 替换为你的IP

// 生产环境
var backendApiUrl = 'https://your-domain.com/api'
```

### 2. 启动后端服务

确保后端服务正在运行：

```bash
# 在 movie-backend 目录下运行
# IDE中运行 MovieBackendApplication.java
# 或使用 mvn spring-boot:run
```

### 3. 开发者工具设置

在微信开发者工具中：
1. 点击右上角"详情"
2. 在"本地设置"中勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

## 测试步骤

1. **启动后端服务**
   - 运行 `MovieBackendApplication.java`
   - 确认服务运行在 `http://localhost:8080`

2. **打开小程序**
   - 在微信开发者工具中打开项目
   - 查看控制台，应该能看到登录日志

3. **查看登录结果**
   - 打开控制台，查看是否有"登录成功"的日志
   - 检查本地存储，应该有 `token`、`userId`、`openId`

## 真机测试

如果要在真机上测试：

1. **修改后端地址**
   ```javascript
   // 在 config.js 中改为你的电脑IP
   var backendApiUrl = 'http://192.168.1.100:8080/api'
   ```

2. **确保手机和电脑在同一网络**

3. **确保后端服务允许外部访问**
   - Spring Boot默认只允许localhost访问
   - 需要在 `application.yml` 中添加：
   ```yaml
   server:
     address: 0.0.0.0  # 允许所有IP访问
   ```

## 登录流程

1. 小程序启动时，`app.js` 的 `onLaunch` 被调用
2. 检查本地是否有token
   - 有：直接使用
   - 没有：调用 `wx.login()` 获取code
3. 将code发送到后端 `/auth/wechat/login` 接口
4. 后端返回token、userId、openId
5. 保存到本地存储和全局变量

## 注意事项

1. **开发环境**：使用 `localhost:8080` 即可
2. **真机测试**：必须使用IP地址，不能使用localhost
3. **生产环境**：需要配置HTTPS和合法域名
4. **测试模式**：后端支持测试模式，无需配置AppID和Secret

## 验证登录

在控制台输入以下代码检查登录状态：

```javascript
// 查看全局数据
getApp().globalData

// 查看本地存储
wx.getStorage({
  key: 'token',
  success: function(res) {
    console.log('Token:', res.data)
  }
})
```



